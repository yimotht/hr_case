{% extends "index.html" %}
{% block content %}
<h1>{{ _('Role Change Requests') }}</h1>

<div class="row" style="margin-bottom: 20px;">
  <a class="btn {% if status_filter == 'pending' %}primary{% endif %}" 
     href="{{ url_for('admin_role_requests', status='pending') }}">Ожидающие</a>
  <a class="btn {% if status_filter == 'approved' %}primary{% endif %}" 
     href="{{ url_for('admin_role_requests', status='approved') }}">Одобренные</a>
  <a class="btn {% if status_filter == 'rejected' %}primary{% endif %}" 
     href="{{ url_for('admin_role_requests', status='rejected') }}">Отклоненные</a>
  <a class="btn" href="{{ url_for('admin_only') }}">Назад в админ-раздел</a>
</div>

{% if requests %}
  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>{{ _('User') }}</th>
          <th>Текущая роль</th>
          <th>Запрашиваемая роль</th>
          <th>{{ _('Request Date') }}</th>
          <th>{{ _('Status') }}</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for req in requests %}
        <tr>
          <td>
            <strong>{{ req.username }}</strong>
            {% if req.first_name or req.last_name %}
              <br><small>{{ req.first_name }} {{ req.last_name }}</small>
            {% endif %}
          </td>
          <td>{{ req.current_role }}</td>
          <td>{{ req.requested_role }}</td>
          <td>{{ req.created_at }}</td>
          <td>
            <span class="badge {% if req.status == 'pending' %}warning{% elif req.status == 'approved' %}success{% else %}danger{% endif %}">
              {{ req.status }}
            </span>
          </td>
          <td>
            {% if req.status == 'pending' %}
              <div class="btn-group">
                <button class="btn btn-sm btn-success" onclick="approveRequest({{ req.id }})">
                  {{ _('Approve') }}
                </button>
                <button class="btn btn-sm btn-danger" onclick="rejectRequest({{ req.id }})">
                  {{ _('Reject') }}
                </button>
              </div>
            {% else %}
              <small>
                {% if req.reviewed_at %}
                  Обработано: {{ req.reviewed_at }}
                {% endif %}
                {% if req.admin_comment %}
                  <br>Комментарий: {{ req.admin_comment }}
                {% endif %}
              </small>
            {% endif %}
          </td>
        </tr>
        {% if req.reason %}
        <tr>
          <td colspan="6">
            <div class="card" style="background: #f8f9fa; margin: 5px 0;">
              <strong>Причина:</strong> {{ req.reason }}
            </div>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <!-- Пагинация -->
  {% if total_count > per_page %}
  <div class="pagination">
    {% if page > 1 %}
      <a href="{{ url_for('admin_role_requests', status=status_filter, page=page-1, per_page=per_page) }}" 
         class="btn">Назад</a>
    {% endif %}
    <span>Страница {{ page }} из {{ (total_count + per_page - 1) // per_page }}</span>
    {% if page * per_page < total_count %}
      <a href="{{ url_for('admin_role_requests', status=status_filter, page=page+1, per_page=per_page) }}" 
         class="btn">Вперед</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="card">
    <p>Нет заявок со статусом "{{ status_filter }}".</p>
  </div>
{% endif %}

<!-- Модальные окна для одобрения/отклонения -->
<div id="approveModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3>Одобрить заявку</h3>
    <form id="approveForm" method="post">
      <div class="form-group">
        <label for="approveComment">{{ _('Admin Comment') }} (необязательно):</label>
        <textarea id="approveComment" name="admin_comment" class="form-control" rows="3"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-success">{{ _('Approve') }}</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('approveModal')">Отмена</button>
      </div>
    </form>
  </div>
</div>

<div id="rejectModal" class="modal" style="display: none;">
  <div class="modal-content">
    <h3>Отклонить заявку</h3>
    <form id="rejectForm" method="post">
      <div class="form-group">
        <label for="rejectComment">{{ _('Admin Comment') }} (рекомендуется):</label>
        <textarea id="rejectComment" name="admin_comment" class="form-control" rows="3" 
                  placeholder="Укажите причину отклонения..."></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-danger">{{ _('Reject') }}</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('rejectModal')">Отмена</button>
      </div>
    </form>
  </div>
</div>

<script>
function approveRequest(requestId) {
  document.getElementById('approveForm').action = '{{ url_for("approve_role_change", request_id=0) }}'.replace('0', requestId);
  document.getElementById('approveModal').style.display = 'block';
}

function rejectRequest(requestId) {
  document.getElementById('rejectForm').action = '{{ url_for("reject_role_change", request_id=0) }}'.replace('0', requestId);
  document.getElementById('rejectModal').style.display = 'block';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  });
}
</script>

<style>
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: #1a1f2e;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #333;
  width: 80%;
  max-width: 500px;
  border-radius: 8px;
}

.table {
  width: 100%;
  border-collapse: collapse;
}

.table th, .table td {
  padding: 8px;
  text-align: left;
  border-bottom: 1px solid #333;
}

.badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8em;
}

.badge.warning { background-color: #ffc107; color: #000; }
.badge.success { background-color: #28a745; color: #fff; }
.badge.danger { background-color: #dc3545; color: #fff; }

.btn-group {
  display: flex;
  gap: 5px;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}
</style>
{% endblock %}
